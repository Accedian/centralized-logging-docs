@startuml Centralized Monitoring Architecture
skinparam componentStyle rectangle
skinparam linetype ortho

title Centralized Monitoring - Distributed PCA Architecture
footer AOD Deployer (Replicated KOTS) + Mobility Collector

' Colors
!define REMOTE_COLOR #E8F5E9
!define CENTRAL_COLOR #E3F2FD
!define STORAGE_COLOR #FFF3E0

' ========================================
' REMOTE SITES (Mobility Collectors)
' ========================================

package "Remote Site 1 - Mobility Collector" REMOTE_COLOR {
    rectangle "Log Collection" {
        [FluentD Agent] as fd1
        [Application Logs] as logs1
    }
    rectangle "Metrics Collection" {
        [Prometheus] as prom1
        [OTEL Collector] as otel1
    }
    logs1 --> fd1
    prom1 --> otel1 : Prometheus metrics
}

package "Remote Site 2 - Mobility Collector" REMOTE_COLOR {
    rectangle "Log Collection" {
        [FluentD Agent] as fd2
        [Application Logs] as logs2
    }
    rectangle "Metrics Collection" {
        [Prometheus] as prom2
        [OTEL Collector] as otel2
    }
    logs2 --> fd2
    prom2 --> otel2
}

package "Remote Site N - Mobility Collector" REMOTE_COLOR {
    rectangle "Log Collection" {
        [FluentD Agent] as fdN
        [Application Logs] as logsN
    }
    rectangle "Metrics Collection" {
        [Prometheus] as promN
        [OTEL Collector] as otelN
    }
    logsN --> fdN
    promN --> otelN
}

' ========================================
' CENTRAL PCA (AOD Deployer)
' ========================================

package "Central PCA - AOD Deployer (Replicated)" CENTRAL_COLOR {
    
    rectangle "Ingress Layer" {
        [nginx Reverse Proxy] as nginx
        note right of nginx
          Ports:
          - 443: Tenant API
          - 2443: Admin API
          - 3443: Zitadel Auth
          Auth: Bearer token via skylight-aaa
        end note
    }
    
    rectangle "Telemetry Processing" {
        [OpenTelemetry Collector] as otel_central
        [otel-mapping-service] as otel_map
        [FluentD Aggregator] as fd_agg
    }
    
    rectangle "Storage Layer" STORAGE_COLOR {
        database "Elasticsearch" as opensearch {
        }
        database "Kafka" as kafka_central
        database "Druid" as druid
    }
    
    rectangle "Visualization" {
        [Grafana] as grafana
        [Skyweather] as skyweather
    }
    
    rectangle "Alerting" {
        [Ignite] as ignite
        [Alert Service] as alert_svc
    }
}

' ========================================
' DATA FLOWS
' ========================================

' Logs flow
fd1 --> fd_agg : Forward logs\n(TCP/TLS)
fd2 --> fd_agg : Forward logs\n(TCP/TLS)
fdN --> fd_agg : Forward logs\n(TCP/TLS)
fd_agg --> opensearch : Index logs

' Metrics flow (OTEL)
otel1 --> nginx : OTLP/HTTP\n(Bearer Auth)
otel2 --> nginx : OTLP/HTTP\n(Bearer Auth)
otelN --> nginx : OTLP/HTTP\n(Bearer Auth)
nginx --> otel_central : Route /otel/*
otel_central --> kafka_central : otel-*-in topics
kafka_central --> otel_map : Transform
otel_map --> kafka_central : otel-mapped-*-in
kafka_central --> ignite : Metrics processing
kafka_central --> druid : Analytics

' Storage to visualization
opensearch --> grafana : Log queries
druid --> grafana : Analytics data
ignite --> grafana : Metrics

' Alerting
ignite --> alert_svc : Metric alerts
opensearch --> alert_svc : Log-based alerts

@enduml
